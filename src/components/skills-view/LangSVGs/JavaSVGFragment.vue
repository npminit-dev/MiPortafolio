<script setup lang="ts">
import { ref, useTemplateRef, watchEffect } from 'vue'
import { ScrollTrigger } from 'gsap/all';
import gsap from 'gsap';
import { DrawSVGPlugin } from 'gsap/DrawSVGPlugin';

// Asegúrate de registrar los plugins si no lo haces en el main.ts
gsap.registerPlugin(ScrollTrigger, DrawSVGPlugin);

type Props = {
  containerAnimation: gsap.core.Animation | null,
  pinnedContainer: HTMLDivElement | null,
}
const { containerAnimation, pinnedContainer } = defineProps<Props>()
let scrollTriggerInstance = ref<ScrollTrigger | null>(null)
const mainCircle = useTemplateRef<HTMLElement>('java-main-circle')

// --- REFERENCIAS (REFS) ---

// 1. Grupo "Class" (Violeta en tu ejemplo)
const classLine = useTemplateRef<SVGLineElement>('class-line')
const classWrapper = useTemplateRef<SVGPathElement>('class-wrapper')
const classContent = useTemplateRef<SVGGElement>('class-content')

// 2. Grupo "Hierarchy" (Verde en tu ejemplo)
const hierarchyLine = useTemplateRef<SVGLineElement>('hierarchy-line')
const hierarchyWrapper = useTemplateRef<SVGPathElement>('hierarchy-wrapper')
const hierarchyContent = useTemplateRef<SVGPathElement>('hierarchy-content') // Es un path, no un grupo

// 3. Grupo "Polymorph" (Azul en tu ejemplo)
const polyLine = useTemplateRef<SVGLineElement>('poly-line')
const polyWrapper = useTemplateRef<SVGPathElement>('poly-wrapper')
const polyContent = useTemplateRef<SVGPathElement>('poly-content') // Es un path

watchEffect(() => {
  if (containerAnimation && pinnedContainer && !scrollTriggerInstance.value && mainCircle.value) {
    const tl = gsap.timeline({
      defaults: { ease: 'power2.out' }
    });

    // 1. ESTADOS INICIALES (Reset)
    // Líneas y Wrappers: "dibujados" al final (invisibles)
    gsap.set([classLine.value, hierarchyLine.value, polyLine.value], { drawSVG: '100% 100%' });
    gsap.set([classWrapper.value, hierarchyWrapper.value, polyWrapper.value], { drawSVG: '0% 0%' }); // Wrappers empiezan en 0
    // Contenidos: Totalmente transparentes
    gsap.set([classContent.value, hierarchyContent.value, polyContent.value], { autoAlpha: 0 });


    // 2. ANIMACIÓN (Secuencia temporal)
    
    // --- Rama Class (t=0) ---
    tl.to(classLine.value, { drawSVG: '100% 0%', duration: 0.4 }, 0)
      .to(classWrapper.value, { drawSVG: '0% 100%', duration: 0.4 }, 0.2)
      .to(classContent.value, { autoAlpha: 1, duration: 0.3 }, 0.4)

    // --- Rama Hierarchy (t=0.2) ---
      .to(hierarchyLine.value, { drawSVG: '100% 0%', duration: 0.4 }, 0.1)
      .to(hierarchyWrapper.value, { drawSVG: '0% 100%', duration: 0.4 }, 0.3)
      .to(hierarchyContent.value, { autoAlpha: 1, duration: 0.3 }, 0.5)

    // --- Rama Polymorph (t=0.4) ---
      .to(polyLine.value, { drawSVG: '100% 0%', duration: 0.4 }, 0.2)
      .to(polyWrapper.value, { drawSVG: '0% 100%', duration: 0.4 }, 0.4)
      .to(polyContent.value, { autoAlpha: 1, duration: 0.3 }, 0.6)


    // 3. TRIGGER
    scrollTriggerInstance.value = ScrollTrigger.create({
      trigger: mainCircle.value,
      start: `center center+=${pinnedContainer?.offsetHeight! / 2}px`,
      end: `center center-=200px${pinnedContainer?.offsetHeight! / 2}px`,
      anticipatePin: 1,
      containerAnimation: containerAnimation,
      animation: tl,
      toggleActions: 'play reverse play reverse'
    })
  }
})
</script>

<template>
  <circle fill="var(--color-plasma-purple-950)" ref="java-main-circle" cx="1643" cy="1643.09" r="69.5" stroke="var(--color-ghost-200)" vector-effect="non-scaling-stroke"/>
  <circle cx="1643.18" cy="1643.18" r="76.5" transform="rotate(45 1643.18 1643.18)" stroke="var(--color-ghost-200)" vector-effect="non-scaling-stroke"/>

  <path
        d="M1633.52 1693.58C1651.6 1694.76 1679.38 1692.94 1680.04 1684.28C1680.04 1684.28 1678.77 1687.56 1665.09 1690.17C1657.53 1691.54 1648.83 1692.33 1639.94 1692.33C1632.66 1692.33 1625.51 1691.8 1618.52 1690.78L1619.32 1690.88C1619.32 1690.87 1621.63 1692.81 1633.52 1693.58ZM1653.05 1592.27C1653.05 1592.27 1663.48 1602.83 1643.15 1619.08C1626.84 1632.11 1639.43 1639.54 1643.15 1648.03C1633.63 1639.33 1626.65 1631.69 1631.33 1624.57C1638.21 1614.11 1657.26 1609.05 1653.05 1592.27ZM1664.41 1666.74C1683.25 1656.83 1674.54 1647.3 1668.46 1648.59C1667.63 1648.75 1666.9 1648.95 1666.2 1649.21L1666.3 1649.17C1666.7 1648.61 1667.25 1648.17 1667.89 1647.92L1667.92 1647.92C1679.95 1643.64 1689.2 1660.54 1664.03 1667.24C1664.18 1667.1 1664.31 1666.93 1664.4 1666.75L1664.41 1666.74ZM1631.67 1648.21C1631.67 1648.21 1613.41 1652.6 1625.21 1654.19C1628.38 1654.45 1632.08 1654.6 1635.81 1654.6C1640.58 1654.6 1645.29 1654.36 1649.94 1653.88L1649.35 1653.93C1656.91 1653.28 1664.49 1651.91 1664.49 1651.91C1662.71 1652.69 1661.2 1653.52 1659.77 1654.47L1659.9 1654.39C1641.36 1659.33 1605.55 1657.03 1615.86 1651.99C1620.41 1649.61 1625.79 1648.21 1631.49 1648.21C1631.55 1648.21 1631.61 1648.21 1631.68 1648.21L1631.67 1648.21ZM1673.68 1679.1C1673.68 1679.1 1676.52 1681.47 1670.55 1683.3C1659.2 1686.78 1623.31 1687.82 1613.35 1683.44C1609.76 1681.86 1616.49 1679.67 1618.6 1679.21C1619.57 1678.96 1620.69 1678.81 1621.84 1678.81C1621.92 1678.81 1621.99 1678.81 1622.07 1678.82L1622.06 1678.82C1618.07 1675.97 1596.3 1684.39 1611 1686.81C1651.09 1693.38 1684.07 1683.84 1673.68 1679.1ZM1647.67 1640.87C1648.72 1642.14 1649.36 1643.81 1649.36 1645.62C1649.36 1648.05 1648.2 1650.22 1646.42 1651.58L1646.4 1651.59C1646.4 1651.59 1658.7 1645.16 1653.05 1637.12C1647.77 1629.61 1643.72 1625.89 1665.63 1613.03C1665.63 1613.03 1631.25 1621.72 1647.67 1640.87ZM1627.41 1659.74C1627.41 1659.74 1623.11 1662.97 1629.68 1663.66C1632.56 1664.02 1635.88 1664.23 1639.26 1664.23C1645.37 1664.23 1651.33 1663.55 1657.06 1662.25L1656.52 1662.35C1657.67 1663.44 1659.04 1664.31 1660.56 1664.87L1660.65 1664.9C1636.88 1671.93 1610.4 1665.45 1627.41 1659.74L1627.41 1659.74ZM1629.82 1670.87C1629.82 1670.87 1625.98 1673.13 1632.55 1673.89C1634.96 1674.26 1637.74 1674.46 1640.56 1674.46C1645.1 1674.46 1649.51 1673.93 1653.74 1672.92L1653.35 1673C1654.91 1673.96 1656.73 1674.89 1658.63 1675.65L1658.88 1675.74C1639.22 1684.26 1614.38 1675.24 1629.82 1670.87L1629.82 1670.87Z"
    fill="var(--color-ghost-200)" vector-effect="non-scaling-stroke"/>


  <line ref="class-line" x1="1520.49" y1="1515.33" x2="1591.87" y2="1586.71" stroke="var(--color-shadow-500)" vector-effect="non-scaling-stroke"/>
  
  <path ref="class-wrapper"
    d="M1502.41 1473.45C1515.94 1473.45 1526.91 1484.42 1526.91 1497.95C1526.91 1511.48 1515.94 1522.45 1502.41 1522.45C1488.88 1522.45 1477.91 1511.48 1477.91 1497.95C1477.91 1484.42 1488.88 1473.45 1502.41 1473.45Z"
    stroke="var(--color-ghost-200)" vector-effect="non-scaling-stroke"/>
  
  <g ref="class-content" clip-path="url(#clip3_2084_108)" vector-effect="non-scaling-stroke">
    <path
      d="M1502.92 1498.44C1502.82 1498.06 1502.71 1497.59 1502.63 1497.21H1502.61C1502.52 1497.59 1502.44 1498.07 1502.34 1498.44L1501.99 1499.79H1503.28L1502.92 1498.44Z"
      fill="var(--color-ghost-200)" stroke="var(--color-ghost-200)" stroke-width="0.00550801" vector-effect="non-scaling-stroke"/>
    <path
      d="M1514.4 1493.54H1513.65V1489.95C1513.65 1489.92 1513.65 1489.9 1513.65 1489.88C1513.65 1489.74 1513.6 1489.6 1513.5 1489.49L1507.53 1482.66C1507.52 1482.66 1507.52 1482.66 1507.52 1482.65C1507.49 1482.61 1507.44 1482.58 1507.4 1482.55C1507.39 1482.54 1507.37 1482.54 1507.36 1482.53C1507.32 1482.51 1507.28 1482.49 1507.24 1482.48C1507.23 1482.48 1507.22 1482.47 1507.21 1482.47C1507.16 1482.46 1507.12 1482.45 1507.07 1482.45H1492.38C1491.71 1482.45 1491.16 1483 1491.16 1483.67V1493.54H1490.42C1489.46 1493.54 1488.68 1494.32 1488.68 1495.28V1504.31C1488.68 1505.27 1489.46 1506.05 1490.42 1506.05H1491.16V1512.23C1491.16 1512.9 1491.71 1513.45 1492.38 1513.45L1512.44 1513.45C1513.11 1513.45 1513.65 1512.9 1513.65 1512.23V1506.05H1514.4C1515.36 1506.05 1516.14 1505.27 1516.14 1504.31V1495.28C1516.13 1494.32 1515.36 1493.54 1514.4 1493.54ZM1492.38 1483.67H1506.46V1489.89C1506.46 1490.22 1506.73 1490.49 1507.07 1490.49H1512.44V1493.54H1492.38V1483.67ZM1507.58 1499.83C1506.61 1499.46 1505.97 1498.87 1505.97 1497.95C1505.97 1496.87 1506.8 1496.04 1508.18 1496.04C1508.84 1496.04 1509.32 1496.19 1509.67 1496.36L1509.37 1497.52C1509.14 1497.39 1508.73 1497.21 1508.15 1497.21C1507.58 1497.21 1507.31 1497.5 1507.31 1497.83C1507.31 1498.23 1507.64 1498.41 1508.39 1498.72C1509.42 1499.14 1509.9 1499.72 1509.9 1500.62C1509.9 1501.68 1509.15 1502.59 1507.55 1502.59C1506.88 1502.59 1506.22 1502.4 1505.9 1502.2L1506.16 1501.01C1506.52 1501.21 1507.06 1501.41 1507.63 1501.41C1508.23 1501.41 1508.55 1501.14 1508.55 1500.72C1508.55 1500.33 1508.28 1500.1 1507.58 1499.83ZM1505.34 1502.5H1503.92L1503.47 1500.86H1501.81L1501.39 1502.5H1500.02L1501.81 1496.14H1503.53L1505.34 1502.5ZM1499.62 1501.29V1502.5H1495.97V1496.14H1497.3V1501.29H1499.62ZM1490.56 1499.41C1490.56 1497.24 1491.98 1496.04 1493.74 1496.04C1494.43 1496.04 1494.95 1496.19 1495.18 1496.32L1494.91 1497.46C1494.64 1497.34 1494.27 1497.22 1493.8 1497.22C1492.76 1497.22 1491.94 1497.91 1491.94 1499.33C1491.94 1500.6 1492.63 1501.4 1493.81 1501.4C1494.21 1501.4 1494.65 1501.31 1494.91 1501.19L1495.11 1502.32C1494.87 1502.45 1494.32 1502.59 1493.61 1502.59C1491.6 1502.59 1490.56 1501.22 1490.56 1499.41ZM1512.44 1511.91H1492.38V1506.05H1512.44V1511.91ZM1512.22 1502.59C1511.55 1502.59 1510.9 1502.4 1510.57 1502.2L1510.84 1501.01C1511.19 1501.21 1511.74 1501.41 1512.3 1501.41C1512.9 1501.41 1513.22 1501.14 1513.22 1500.72C1513.22 1500.33 1512.95 1500.1 1512.25 1499.83C1511.28 1499.46 1510.65 1498.87 1510.65 1497.95C1510.65 1496.87 1511.48 1496.04 1512.85 1496.04C1513.51 1496.04 1513.99 1496.19 1514.34 1496.36L1514.05 1497.52C1513.81 1497.39 1513.4 1497.21 1512.83 1497.21C1512.25 1497.21 1511.98 1497.5 1511.98 1497.83C1511.98 1498.23 1512.31 1498.41 1513.06 1498.72C1514.09 1499.14 1514.57 1499.72 1514.57 1500.62C1514.57 1501.68 1513.82 1502.59 1512.22 1502.59Z"
      fill="var(--color-ghost-200)" stroke="var(--color-ghost-200)" stroke-width="0.00550801" vector-effect="non-scaling-stroke"/>
  </g>


  <line ref="hierarchy-line" x1="1642.68" y1="1566.75" x2="1642.68" y2="1479.15" stroke="var(--color-shadow-500)" vector-effect="non-scaling-stroke"/>
  
  <path ref="hierarchy-wrapper"
    d="M1643.18 1429.65C1656.71 1429.65 1667.68 1440.62 1667.68 1454.15C1667.68 1467.69 1656.71 1478.65 1643.18 1478.65C1629.65 1478.65 1618.68 1467.69 1618.68 1454.15C1618.68 1440.62 1629.65 1429.65 1643.18 1429.65Z"
    stroke="var(--color-ghost-200)" vector-effect="non-scaling-stroke"/>
  
  <path ref="hierarchy-content"
    d="M1646.15 1460.09L1646.15 1467.22C1646.15 1467.69 1646.34 1468.14 1646.67 1468.48C1647 1468.81 1647.46 1469 1647.93 1469L1655.05 1469C1655.53 1469 1655.98 1468.81 1656.31 1468.48C1656.65 1468.14 1656.84 1467.69 1656.84 1467.22L1656.84 1460.09C1656.84 1459.62 1656.65 1459.17 1656.31 1458.83C1655.98 1458.5 1655.53 1458.31 1655.05 1458.31L1652.09 1458.31L1652.09 1456.53C1652.08 1455.43 1651.65 1454.37 1650.87 1453.59C1650.09 1452.81 1649.03 1452.37 1647.93 1452.37L1643.77 1452.37L1643.77 1447.62L1646.15 1447.62C1646.62 1447.62 1647.07 1447.43 1647.41 1447.1C1647.74 1446.77 1647.93 1446.31 1647.93 1445.84L1647.93 1439.9C1647.93 1439.43 1647.74 1438.98 1647.41 1438.65C1647.07 1438.31 1646.62 1438.12 1646.15 1438.12L1640.21 1438.12C1639.74 1438.12 1639.29 1438.31 1638.95 1438.65C1638.62 1438.98 1638.43 1439.43 1638.43 1439.9L1638.43 1445.84C1638.43 1446.31 1638.62 1446.77 1638.95 1447.1C1639.29 1447.43 1639.74 1447.62 1640.21 1447.62L1642.59 1447.62L1642.59 1452.37L1638.43 1452.37C1637.33 1452.37 1636.27 1452.81 1635.49 1453.59C1634.71 1454.37 1634.27 1455.43 1634.27 1456.53L1634.27 1458.31L1631.3 1458.31C1630.83 1458.31 1630.38 1458.5 1630.05 1458.83C1629.71 1459.17 1629.52 1459.62 1629.52 1460.09L1629.52 1467.22C1629.52 1467.69 1629.71 1468.14 1630.05 1468.48C1630.38 1468.81 1630.83 1469 1631.3 1469L1638.43 1469C1638.9 1469 1639.35 1468.81 1639.69 1468.48C1640.02 1468.14 1640.21 1467.69 1640.21 1467.22L1640.21 1460.09C1640.21 1459.62 1640.02 1459.17 1639.69 1458.83C1639.35 1458.5 1638.9 1458.31 1638.43 1458.31L1635.46 1458.31L1635.46 1456.53C1635.46 1455.74 1635.77 1454.99 1636.33 1454.43C1636.89 1453.87 1637.64 1453.56 1638.43 1453.56L1647.93 1453.56C1648.72 1453.56 1649.47 1453.87 1650.03 1454.43C1650.58 1454.99 1650.9 1455.74 1650.9 1456.53L1650.9 1458.31L1647.93 1458.31C1647.46 1458.31 1647 1458.5 1646.67 1458.83C1646.34 1459.17 1646.15 1459.62 1646.15 1460.09ZM1640.21 1446.44C1640.05 1446.44 1639.9 1446.37 1639.79 1446.26C1639.68 1446.15 1639.62 1446 1639.62 1445.84L1639.62 1439.9C1639.62 1439.75 1639.68 1439.6 1639.79 1439.48C1639.9 1439.37 1640.05 1439.31 1640.21 1439.31L1646.15 1439.31C1646.31 1439.31 1646.46 1439.37 1646.57 1439.48C1646.68 1439.6 1646.74 1439.75 1646.74 1439.9L1646.74 1445.84C1646.74 1446 1646.68 1446.15 1646.57 1446.26C1646.46 1446.37 1646.31 1446.44 1646.15 1446.44L1640.21 1446.44ZM1638.43 1459.5C1638.59 1459.5 1638.74 1459.56 1638.85 1459.67C1638.96 1459.78 1639.02 1459.93 1639.02 1460.09L1639.02 1467.22C1639.02 1467.37 1638.96 1467.53 1638.85 1467.64C1638.74 1467.75 1638.59 1467.81 1638.43 1467.81L1631.3 1467.81C1631.15 1467.81 1631 1467.75 1630.88 1467.64C1630.77 1467.53 1630.71 1467.37 1630.71 1467.22L1630.71 1460.09C1630.71 1459.93 1630.77 1459.78 1630.88 1459.67C1631 1459.56 1631.15 1459.5 1631.3 1459.5L1638.43 1459.5ZM1655.05 1459.5C1655.21 1459.5 1655.36 1459.56 1655.47 1459.67C1655.59 1459.78 1655.65 1459.93 1655.65 1460.09L1655.65 1467.22C1655.65 1467.37 1655.59 1467.53 1655.47 1467.64C1655.36 1467.75 1655.21 1467.81 1655.05 1467.81L1647.93 1467.81C1647.77 1467.81 1647.62 1467.75 1647.51 1467.64C1647.4 1467.53 1647.34 1467.37 1647.34 1467.22L1647.34 1460.09C1647.34 1459.93 1647.4 1459.78 1647.51 1459.67C1647.62 1459.56 1647.77 1459.5 1647.93 1459.5L1655.05 1459.5Z"
    fill="var(--color-ghost-200)" stroke="var(--color-ghost-200)" stroke-width="0.768" vector-effect="non-scaling-stroke"/>


  <path ref="poly-wrapper"
    d="M1777.07 1748.68C1790.61 1748.68 1801.57 1759.65 1801.57 1773.18C1801.57 1786.71 1790.61 1797.68 1777.07 1797.68C1763.54 1797.68 1752.57 1786.71 1752.57 1773.18C1752.57 1759.65 1763.54 1748.68 1777.07 1748.68Z"
    stroke="var(--color-ghost-200)" vector-effect="non-scaling-stroke"/>
  
  <path ref="poly-content"
    d="M1769.06 1769.64L1785.08 1769.64C1785.56 1769.64 1785.95 1769.25 1785.95 1768.78C1785.95 1768.62 1785.91 1768.47 1785.83 1768.34L1785.84 1768.34L1777.82 1754.47C1777.66 1754.22 1777.39 1754.06 1777.07 1754.06C1776.76 1754.06 1776.49 1754.22 1776.32 1754.46L1776.32 1754.47L1768.31 1768.34C1768.24 1768.47 1768.2 1768.62 1768.2 1768.78C1768.2 1769.25 1768.59 1769.64 1769.06 1769.64ZM1777.07 1756.63L1783.58 1767.91L1770.57 1767.91L1777.07 1756.63ZM1767.64 1772.53C1767.58 1772.53 1767.51 1772.53 1767.45 1772.53C1763.14 1772.53 1759.64 1776.03 1759.64 1780.34C1759.64 1784.65 1763.14 1788.15 1767.45 1788.15C1767.51 1788.15 1767.58 1788.14 1767.65 1788.14H1767.64C1767.69 1788.14 1767.76 1788.15 1767.83 1788.15C1772.14 1788.15 1775.63 1784.65 1775.63 1780.34C1775.63 1776.03 1772.14 1772.53 1767.83 1772.53C1767.76 1772.53 1767.69 1772.53 1767.63 1772.53H1767.64ZM1767.64 1786.41C1767.58 1786.41 1767.52 1786.41 1767.45 1786.41C1764.1 1786.41 1761.38 1783.69 1761.38 1780.34C1761.38 1776.98 1764.1 1774.27 1767.45 1774.27C1767.52 1774.27 1767.58 1774.27 1767.65 1774.27H1767.64C1767.69 1774.27 1767.76 1774.27 1767.82 1774.27C1771.18 1774.27 1773.89 1776.99 1773.89 1780.34C1773.89 1783.69 1771.18 1786.41 1767.82 1786.41C1767.76 1786.41 1767.69 1786.41 1767.63 1786.41H1767.64ZM1790.95 1772.53L1781.7 1772.53C1779.94 1772.54 1778.52 1773.96 1778.52 1775.71L1778.52 1784.96C1778.52 1786.72 1779.94 1788.14 1781.7 1788.14L1790.95 1788.14C1792.7 1788.14 1794.13 1786.72 1794.13 1784.96L1794.13 1775.71C1794.13 1773.96 1792.7 1772.54 1790.95 1772.53ZM1792.39 1784.96C1792.39 1785.76 1791.75 1786.41 1790.95 1786.41L1781.7 1786.41C1780.9 1786.41 1780.26 1785.76 1780.25 1784.96L1780.25 1775.71C1780.26 1774.92 1780.9 1774.27 1781.7 1774.27L1790.95 1774.27C1791.75 1774.27 1792.39 1774.92 1792.39 1775.71L1792.39 1784.96Z"
    fill="var(--color-ghost-200)" stroke="var(--color-ghost-200)" stroke-width="0.00032" vector-effect="non-scaling-stroke"/>
  
  <line ref="poly-line" x1="1760.11" y1="1755.01" x2="1699.79" y2="1694.68" stroke="var(--color-shadow-500)" vector-effect="non-scaling-stroke"/>

</template>
