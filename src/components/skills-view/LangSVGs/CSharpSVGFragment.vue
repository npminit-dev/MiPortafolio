<script setup lang="ts">
import { ref, useTemplateRef, watchEffect } from 'vue'
import { ScrollTrigger } from 'gsap/all';
import gsap from 'gsap';
import { DrawSVGPlugin } from 'gsap/DrawSVGPlugin';

// Asegúrate de registrar los plugins si no lo haces en el main.ts
gsap.registerPlugin(ScrollTrigger, DrawSVGPlugin);

type Props = {
  containerAnimation: gsap.core.Animation | null,
  pinnedContainer: HTMLDivElement | null,
}
const { containerAnimation, pinnedContainer } = defineProps<Props>()
let scrollTriggerInstance = ref<ScrollTrigger | null>(null)
const mainCircle = useTemplateRef<HTMLElement>('csharp-main-circle')

// --- REFERENCIAS (REFS) ---

// 1. Grupo "Inheritance/Class" (Izquierda)
const inheritanceLine = useTemplateRef<SVGLineElement>('inheritance-line')
const inheritanceWrapper = useTemplateRef<SVGPathElement>('inheritance-wrapper')
const inheritanceContent = useTemplateRef<SVGGElement>('inheritance-content')

// 2. Grupo "Interface/Composition" (Derecha)
const interfaceLine = useTemplateRef<SVGLineElement>('interface-line')
const interfaceWrapper = useTemplateRef<SVGPathElement>('interface-wrapper')
const interfaceContent = useTemplateRef<SVGGElement>('interface-content')

watchEffect(() => {
  if (containerAnimation && pinnedContainer && !scrollTriggerInstance.value && mainCircle.value) {
    const tl = gsap.timeline({
      defaults: { ease: 'power2.out' }
    });

    // 1. ESTADOS INICIALES (Reset)
    // Líneas y Wrappers: "dibujados" al final (invisibles)
    // Las líneas inician dibujadas al 100% de 100% (invisibles) y se animan a 100% 0%
    gsap.set([inheritanceLine.value, interfaceLine.value], { drawSVG: '100% 100%' });
    // Los wrappers (círculos) inician dibujados al 0% 0% (invisibles) y se animan a 0% 100%
    gsap.set([inheritanceWrapper.value, interfaceWrapper.value], { drawSVG: '0% 0%' }); 
    // Contenidos: Totalmente transparentes
    gsap.set([inheritanceContent.value, interfaceContent.value], { autoAlpha: 0 });


    // 2. ANIMACIÓN (Secuencia temporal)
    
    // --- Rama Inheritance (Izquierda, t=0) ---
    tl.to(inheritanceLine.value, { drawSVG: '100% 0%', duration: 0.3 }, 0)
      .to(inheritanceWrapper.value, { drawSVG: '0% 100%', duration: 0.3 }, 0.2)
      .to(inheritanceContent.value, { autoAlpha: 1, duration: 0.3 }, 0.4)

    // --- Rama Interface (Derecha, t=0.2) ---
      .to(interfaceLine.value, { drawSVG: '100% 0%', duration: .3 }, 0.1) // Empieza un poco después
      .to(interfaceWrapper.value, { drawSVG: '0% 100%', duration: .3 }, 0.3) // Retraso relativo a su línea
      .to(interfaceContent.value, { autoAlpha: 1, duration: 0.3 }, 0.5) // Retraso relativo a su wrapper


    // 3. TRIGGER
    scrollTriggerInstance.value = ScrollTrigger.create({
      trigger: mainCircle.value,
      start: `center center+=${pinnedContainer?.offsetHeight! / 2}px`,
      end: `center center-=200px${pinnedContainer?.offsetHeight! / 2}px`,
      anticipatePin: 1,
      containerAnimation: containerAnimation,
      animation: tl,
      toggleActions: 'play reverse play reverse'
    })
  }
})
</script>

<template>
  <circle fill="var(--color-plasma-purple-950)" ref="csharp-main-circle" cx="2295.68" cy="2292.14" r="76.5" transform="rotate(45 2295.68 2292.14)"
    stroke="var(--color-ghost-200)" />
  <circle cx="2295.68" cy="2292.14" r="69.5" stroke="var(--color-ghost-200)" />
  <path
    d="M2295.68 2333.46C2272.89 2333.46 2254.36 2314.92 2254.36 2292.14C2254.36 2269.35 2272.89 2250.82 2295.68 2250.82C2310.38 2250.82 2324.09 2258.73 2331.46 2271.46L2313.58 2281.82C2311.76 2278.68 2309.15 2276.07 2306.01 2274.26C2302.87 2272.45 2299.31 2271.49 2295.68 2271.48C2290.2 2271.49 2284.95 2273.67 2281.08 2277.54C2277.21 2281.41 2275.03 2286.66 2275.02 2292.14C2275.03 2297.62 2277.2 2302.87 2281.08 2306.74C2284.95 2310.62 2290.2 2312.8 2295.68 2312.81C2299.31 2312.8 2302.87 2311.84 2306.01 2310.02C2309.15 2308.21 2311.76 2305.6 2313.58 2302.47L2331.46 2312.81C2327.82 2319.08 2322.6 2324.29 2316.32 2327.91C2310.05 2331.53 2302.93 2333.45 2295.68 2333.46Z"
    fill="var(--color-ghost-200)" />
  <rect x="2323.47" y="2283.42" width="3" height="17.436" fill="var(--color-ghost-200)" />
  <rect x="2329.34" y="2283.42" width="3" height="17.436" fill="var(--color-ghost-200)" />
  <rect x="2319.17" y="2290.7" width="3" height="17.436" transform="rotate(-90 2319.17 2290.7)"
    fill="var(--color-ghost-200)" />
  <rect x="2319.2" y="2296.57" width="3" height="17.436" transform="rotate(-90 2319.2 2296.57)"
    fill="var(--color-ghost-200)" />

  <path ref="inheritance-wrapper"
    d="M2153.41 2124.68C2166.94 2124.68 2177.91 2135.65 2177.91 2149.18C2177.91 2162.71 2166.94 2173.68 2153.41 2173.68C2139.88 2173.68 2128.91 2162.71 2128.91 2149.18C2128.91 2135.65 2139.88 2124.68 2153.41 2124.68Z"
    stroke="var(--color-ghost-200)" vector-effect="non-scaling-stroke"/>
  
  <g ref="inheritance-content" clip-path="url(#clip4_2084_108)" vector-effect="non-scaling-stroke">
    <path
      d="M2163.41 2143.59L2160.41 2143.59V2138.59C2160.41 2134.72 2157.27 2131.59 2153.41 2131.59C2149.54 2131.59 2146.41 2134.72 2146.41 2138.59V2143.59H2143.41C2142.3 2143.59 2141.41 2144.48 2141.41 2145.59L2141.41 2161.59C2141.41 2162.69 2142.3 2163.59 2143.41 2163.59L2163.41 2163.59C2164.51 2163.59 2165.41 2162.69 2165.41 2161.59L2165.41 2145.59C2165.41 2144.48 2164.51 2143.59 2163.41 2143.59ZM2147.41 2138.59C2147.41 2135.27 2150.09 2132.59 2153.41 2132.59C2156.72 2132.59 2159.41 2135.27 2159.41 2138.59V2143.59H2157.41V2138.59C2157.41 2136.38 2155.62 2134.59 2153.41 2134.59C2151.2 2134.59 2149.41 2136.38 2149.41 2138.59V2143.59H2147.41V2138.59ZM2150.41 2138.59C2150.41 2136.93 2151.75 2135.59 2153.41 2135.59C2155.06 2135.59 2156.41 2136.93 2156.41 2138.59V2143.59H2150.41V2138.59ZM2164.41 2161.59C2164.41 2162.14 2163.96 2162.59 2163.41 2162.59L2143.41 2162.59C2142.86 2162.59 2142.41 2162.14 2142.41 2161.59V2159.59L2164.41 2159.59V2161.59ZM2164.41 2158.59L2142.41 2158.59L2142.41 2148.59L2164.41 2148.59L2164.41 2158.59ZM2164.41 2147.59L2142.41 2147.59V2145.59C2142.41 2145.04 2142.86 2144.59 2143.41 2144.59L2163.41 2144.59C2163.96 2144.59 2164.41 2145.04 2164.41 2145.59V2147.59Z"
      fill="var(--color-ghost-200)" stroke="var(--color-ghost-200)" stroke-width="0.00064" />
    <path
      d="M2151.91 2154.08V2156.09C2151.91 2156.92 2152.58 2157.59 2153.41 2157.59C2154.24 2157.59 2154.91 2156.92 2154.91 2156.09V2154.08C2155.51 2153.62 2155.91 2152.9 2155.91 2152.09C2155.91 2150.71 2154.79 2149.59 2153.41 2149.59C2152.03 2149.59 2150.91 2150.71 2150.91 2152.09C2150.91 2152.9 2151.3 2153.62 2151.91 2154.08ZM2153.41 2150.59C2154.24 2150.59 2154.91 2151.26 2154.91 2152.09C2154.91 2152.74 2154.49 2153.29 2153.91 2153.5V2156.09C2153.91 2156.36 2153.68 2156.59 2153.41 2156.59C2153.13 2156.59 2152.91 2156.36 2152.91 2156.09V2153.5C2152.33 2153.29 2151.91 2152.74 2151.91 2152.09C2151.91 2151.26 2152.58 2150.59 2153.41 2150.59Z"
      fill="var(--color-ghost-200)" stroke="var(--color-ghost-200)" stroke-width="0.00064" />
  </g>
  <line ref="inheritance-line" x1="2171.49" y1="2166.56" x2="2242.87" y2="2237.94" stroke="var(--color-shadow-500)" vector-effect="non-scaling-stroke"/>

  <line ref="interface-line" x1="2421.5" y1="2416.62" x2="2350.79" y2="2345.91" stroke="var(--color-shadow-500)" vector-effect="non-scaling-stroke"/>
  
  <path ref="interface-wrapper"
    d="M2438.5 2410.11C2452.04 2410.11 2463 2421.08 2463 2434.61C2463 2448.14 2452.04 2459.11 2438.5 2459.11C2424.97 2459.11 2414 2448.14 2414 2434.61C2414 2421.08 2424.97 2410.11 2438.5 2410.11Z"
    stroke="var(--color-ghost-200)" vector-effect="non-scaling-stroke"/>
  
  <g ref="interface-content" clip-path="url(#clip5_2084_108)" vector-effect="non-scaling-stroke">
    <path
      d="M2431.15 2449.81L2431.84 2448.65C2431.89 2448.57 2431.97 2448.53 2432.06 2448.53C2432.15 2448.53 2432.23 2448.58 2432.27 2448.66L2432.9 2449.85C2432.99 2450.03 2433.19 2450.13 2433.39 2450.11C2433.59 2450.08 2433.75 2449.93 2433.8 2449.73L2434.1 2448.42C2434.12 2448.33 2434.18 2448.27 2434.27 2448.24C2434.35 2448.22 2434.44 2448.24 2434.51 2448.3L2435.48 2449.24C2435.62 2449.38 2435.84 2449.41 2436.02 2449.33C2436.2 2449.24 2436.31 2449.05 2436.29 2448.85L2436.17 2447.51C2436.17 2447.42 2436.21 2447.33 2436.28 2447.28C2436.35 2447.23 2436.45 2447.22 2436.53 2447.26L2437.74 2447.86C2437.92 2447.94 2438.14 2447.91 2438.28 2447.77C2438.43 2447.63 2438.47 2447.42 2438.39 2447.23L2437.86 2445.99C2437.83 2445.91 2437.84 2445.82 2437.9 2445.75C2437.95 2445.68 2438.04 2445.64 2438.13 2445.65L2439.46 2445.84C2439.66 2445.87 2439.86 2445.77 2439.95 2445.6C2440.05 2445.42 2440.02 2445.2 2439.89 2445.05L2439.01 2444.03C2438.95 2443.96 2438.93 2443.87 2438.96 2443.79C2438.99 2443.7 2439.06 2443.64 2439.15 2443.63L2440.48 2443.4C2440.67 2443.36 2440.83 2443.21 2440.87 2443.01C2440.9 2442.81 2440.81 2442.61 2440.64 2442.51L2439.48 2441.81C2439.41 2441.77 2439.36 2441.69 2439.37 2441.6C2439.37 2441.51 2439.42 2441.43 2439.5 2441.39L2440.69 2440.76C2440.87 2440.66 2440.97 2440.47 2440.94 2440.27C2440.91 2440.07 2440.77 2439.9 2440.57 2439.86L2439.26 2439.56C2439.17 2439.54 2439.1 2439.47 2439.07 2439.39C2439.05 2439.3 2439.07 2439.21 2439.13 2439.15L2440.07 2438.18C2440.21 2438.03 2440.25 2437.82 2440.16 2437.64C2440.07 2437.45 2439.88 2437.34 2439.68 2437.36L2438.34 2437.48C2438.25 2437.49 2438.17 2437.45 2438.11 2437.38C2438.06 2437.3 2438.06 2437.21 2438.1 2437.13L2438.69 2435.92C2438.78 2435.74 2438.74 2435.52 2438.61 2435.37C2438.52 2435.28 2438.4 2435.23 2438.28 2435.22L2439.03 2434.89C2439.12 2434.85 2439.23 2434.86 2439.3 2434.91C2439.38 2434.97 2439.42 2435.07 2439.41 2435.16L2439.23 2436.63C2439.2 2436.85 2439.32 2437.06 2439.51 2437.17C2439.71 2437.27 2439.95 2437.24 2440.11 2437.09L2441.21 2436.1C2441.28 2436.03 2441.38 2436.01 2441.47 2436.04C2441.57 2436.07 2441.63 2436.15 2441.65 2436.24L2441.93 2437.7C2441.98 2437.91 2442.15 2438.08 2442.37 2438.12C2442.59 2438.15 2442.8 2438.05 2442.91 2437.86L2443.65 2436.58C2443.7 2436.49 2443.79 2436.44 2443.88 2436.44C2443.98 2436.44 2444.07 2436.5 2444.12 2436.58L2444.83 2437.87C2444.94 2438.07 2445.16 2438.17 2445.38 2438.14C2445.6 2438.11 2445.77 2437.94 2445.82 2437.73L2446.12 2436.28C2446.14 2436.18 2446.21 2436.11 2446.3 2436.08C2446.39 2436.05 2446.5 2436.07 2446.57 2436.14L2447.65 2437.15C2447.81 2437.3 2448.05 2437.33 2448.25 2437.23C2448.44 2437.13 2448.56 2436.92 2448.54 2436.7L2448.38 2435.23C2448.37 2435.14 2448.41 2435.04 2448.49 2434.98C2448.57 2434.93 2448.67 2434.92 2448.76 2434.96L2450.1 2435.58C2450.3 2435.68 2450.54 2435.64 2450.69 2435.48C2450.85 2435.33 2450.9 2435.09 2450.81 2434.89L2450.2 2433.54C2450.16 2433.45 2450.17 2433.35 2450.23 2433.27C2450.29 2433.19 2450.38 2433.15 2450.48 2433.16L2451.95 2433.34C2452.17 2433.37 2452.38 2433.26 2452.48 2433.06C2452.58 2432.86 2452.55 2432.62 2452.4 2432.46L2451.41 2431.36C2451.35 2431.29 2451.33 2431.19 2451.36 2431.1C2451.39 2431.01 2451.47 2430.94 2451.56 2430.92L2453.01 2430.64C2453.23 2430.6 2453.4 2430.42 2453.43 2430.2C2453.47 2429.99 2453.37 2429.77 2453.17 2429.66L2451.89 2428.92C2451.81 2428.87 2451.76 2428.78 2451.76 2428.69C2451.76 2428.59 2451.81 2428.5 2451.9 2428.45L2453.19 2427.74C2453.38 2427.63 2453.49 2427.41 2453.46 2427.2C2453.42 2426.98 2453.26 2426.8 2453.04 2426.76L2451.59 2426.45C2451.5 2426.43 2451.42 2426.36 2451.39 2426.27C2451.36 2426.18 2451.39 2426.08 2451.45 2426L2452.46 2424.92C2452.61 2424.76 2452.65 2424.52 2452.55 2424.33C2452.45 2424.13 2452.24 2424.01 2452.02 2424.04L2450.55 2424.19C2450.45 2424.21 2450.36 2424.16 2450.3 2424.08C2450.24 2424 2450.23 2423.9 2450.27 2423.81L2450.9 2422.47C2450.99 2422.27 2450.95 2422.04 2450.8 2421.88C2450.64 2421.72 2450.41 2421.68 2450.2 2421.77L2448.85 2422.37C2448.77 2422.41 2448.66 2422.4 2448.58 2422.34C2448.51 2422.28 2448.47 2422.19 2448.48 2422.09L2448.66 2420.62C2448.68 2420.41 2448.57 2420.19 2448.38 2420.09C2448.18 2419.99 2447.94 2420.02 2447.78 2420.17L2446.68 2421.16C2446.61 2421.22 2446.51 2421.25 2446.41 2421.22C2446.32 2421.18 2446.25 2421.11 2446.24 2421.01L2445.95 2419.56C2445.91 2419.34 2445.74 2419.17 2445.52 2419.14C2445.3 2419.1 2445.09 2419.21 2444.97 2419.4L2444.24 2420.68C2444.19 2420.76 2444.1 2420.82 2444 2420.81C2443.91 2420.81 2443.82 2420.76 2443.77 2420.68L2443.05 2419.38C2442.95 2419.19 2442.73 2419.08 2442.51 2419.12C2442.29 2419.15 2442.12 2419.31 2442.07 2419.53L2441.77 2420.98C2441.75 2421.07 2441.68 2421.15 2441.59 2421.18C2441.49 2421.21 2441.39 2421.19 2441.32 2421.12L2440.24 2420.11C2440.08 2419.96 2439.84 2419.92 2439.64 2420.02C2439.44 2420.12 2439.33 2420.33 2439.35 2420.55L2439.51 2422.02C2439.52 2422.12 2439.48 2422.22 2439.4 2422.27C2439.32 2422.33 2439.22 2422.34 2439.13 2422.3L2437.79 2421.67C2437.59 2421.58 2437.35 2421.62 2437.19 2421.77C2437.04 2421.93 2436.99 2422.17 2437.08 2422.37L2437.69 2423.72C2437.73 2423.81 2437.72 2423.91 2437.66 2423.99C2437.6 2424.07 2437.5 2424.11 2437.41 2424.09L2435.94 2423.91C2435.72 2423.89 2435.51 2424 2435.41 2424.2C2435.3 2424.39 2435.33 2424.63 2435.48 2424.8L2436.48 2425.89C2436.54 2425.96 2436.56 2426.06 2436.53 2426.16C2436.5 2426.25 2436.42 2426.32 2436.33 2426.34L2434.88 2426.62C2434.66 2426.66 2434.49 2426.83 2434.45 2427.05C2434.42 2427.27 2434.52 2427.49 2434.71 2427.6L2436 2428.33C2436.08 2428.38 2436.13 2428.47 2436.13 2428.57C2436.13 2428.67 2436.08 2428.76 2435.99 2428.8L2434.7 2429.52C2434.51 2429.63 2434.4 2429.84 2434.43 2430.06C2434.46 2430.28 2434.63 2430.45 2434.85 2430.5L2436.29 2430.8C2436.39 2430.82 2436.47 2430.89 2436.49 2430.99C2436.52 2431.08 2436.5 2431.18 2436.44 2431.25L2435.43 2432.33C2435.28 2432.49 2435.24 2432.73 2435.34 2432.93C2435.44 2433.13 2435.65 2433.24 2435.87 2433.22L2437.34 2433.06C2437.44 2433.05 2437.53 2433.09 2437.59 2433.17C2437.64 2433.25 2437.65 2433.35 2437.61 2433.44L2436.99 2434.78C2436.89 2434.98 2436.94 2435.22 2437.09 2435.38C2437.18 2435.47 2437.3 2435.52 2437.43 2435.53L2436.83 2435.79C2436.75 2435.83 2436.65 2435.81 2436.58 2435.76C2436.51 2435.71 2436.48 2435.62 2436.49 2435.53L2436.68 2434.2C2436.71 2434 2436.61 2433.8 2436.43 2433.7C2436.25 2433.61 2436.03 2433.63 2435.88 2433.76L2434.87 2434.65C2434.8 2434.71 2434.71 2434.73 2434.62 2434.7C2434.54 2434.67 2434.48 2434.59 2434.46 2434.51L2434.23 2433.18C2434.2 2432.98 2434.04 2432.82 2433.84 2432.79C2433.65 2432.75 2433.44 2432.84 2433.34 2433.01L2432.65 2434.17C2432.6 2434.25 2432.52 2434.29 2432.43 2434.29C2432.34 2434.29 2432.26 2434.24 2432.22 2434.16L2431.59 2432.97C2431.5 2432.79 2431.3 2432.69 2431.1 2432.72C2430.9 2432.74 2430.74 2432.89 2430.69 2433.09L2430.39 2434.4C2430.37 2434.49 2430.31 2434.56 2430.22 2434.58C2430.14 2434.61 2430.05 2434.58 2429.98 2434.52L2429.01 2433.58C2428.87 2433.44 2428.65 2433.41 2428.47 2433.5C2428.29 2433.58 2428.18 2433.77 2428.2 2433.97L2428.32 2435.32C2428.32 2435.4 2428.28 2435.49 2428.21 2435.54C2428.14 2435.59 2428.04 2435.6 2427.96 2435.56L2426.75 2434.97C2426.57 2434.88 2426.35 2434.91 2426.21 2435.05C2426.06 2435.19 2426.02 2435.4 2426.1 2435.59L2426.63 2436.83C2426.66 2436.91 2426.65 2437 2426.59 2437.07C2426.54 2437.14 2426.45 2437.18 2426.36 2437.17L2425.03 2436.98C2424.83 2436.95 2424.63 2437.05 2424.54 2437.23C2424.44 2437.4 2424.47 2437.62 2424.6 2437.77L2425.48 2438.79C2425.54 2438.86 2425.56 2438.95 2425.53 2439.03C2425.5 2439.12 2425.43 2439.18 2425.34 2439.19L2424.01 2439.42C2423.82 2439.46 2423.66 2439.61 2423.62 2439.81C2423.59 2440.01 2423.68 2440.21 2423.85 2440.31L2425.01 2441.01C2425.08 2441.05 2425.13 2441.14 2425.12 2441.22C2425.12 2441.31 2425.07 2441.39 2424.99 2441.43L2423.8 2442.07C2423.63 2442.16 2423.52 2442.36 2423.55 2442.56C2423.58 2442.75 2423.72 2442.92 2423.92 2442.96L2425.24 2443.26C2425.32 2443.28 2425.39 2443.35 2425.42 2443.43C2425.44 2443.52 2425.42 2443.61 2425.36 2443.67L2424.42 2444.64C2424.28 2444.79 2424.24 2445 2424.33 2445.19C2424.42 2445.37 2424.61 2445.48 2424.81 2445.46L2426.15 2445.34C2426.24 2445.33 2426.32 2445.37 2426.38 2445.44C2426.43 2445.52 2426.43 2445.61 2426.39 2445.69L2425.8 2446.9C2425.71 2447.08 2425.75 2447.3 2425.88 2447.45C2426.02 2447.59 2426.24 2447.64 2426.42 2447.56L2427.66 2447.03C2427.74 2447 2427.84 2447.01 2427.91 2447.06C2427.98 2447.12 2428.02 2447.2 2428 2447.29L2427.81 2448.63C2427.78 2448.82 2427.88 2449.02 2428.06 2449.12C2428.24 2449.21 2428.46 2449.19 2428.61 2449.06L2429.62 2448.17C2429.69 2448.11 2429.78 2448.1 2429.87 2448.12C2429.95 2448.15 2430.01 2448.23 2430.03 2448.31L2430.26 2449.64C2430.29 2449.84 2430.45 2450 2430.65 2450.03C2430.85 2450.07 2431.05 2449.98 2431.15 2449.81ZM2439.35 2428.63C2439.35 2426.09 2441.4 2424.03 2443.94 2424.03C2446.48 2424.03 2448.54 2426.09 2448.54 2428.63C2448.54 2431.17 2446.48 2433.23 2443.94 2433.23C2441.4 2433.23 2439.35 2431.17 2439.35 2428.63ZM2428.05 2441.33C2428.1 2439.02 2430.01 2437.18 2432.32 2437.22C2434.64 2437.26 2436.48 2439.17 2436.44 2441.49C2436.39 2443.8 2434.48 2445.65 2432.17 2445.6C2429.85 2445.56 2428.01 2443.65 2428.05 2441.33Z"
      fill="var(--color-ghost-200)" stroke="var(--color-ghost-200)" stroke-width="0.002" />
  </g>
</template>